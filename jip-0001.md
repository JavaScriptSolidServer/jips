# JIP-0001: did:nostr Authentication & Schnorr Signatures

## Status

Draft

## Abstract

Add support for Nostr-based authentication to JSS using Schnorr signatures (NIP-98), enabling both direct resource authorization via `did:nostr` URIs in ACLs and single sign-on (SSO) with WebID linking.

## Motivation

Nostr is a decentralized protocol with millions of users who already have cryptographic keypairs. By supporting Nostr authentication:

1. **Passwordless login** - Users authenticate with cryptographic signatures, not passwords
2. **Decentralized identity** - No dependency on centralized identity providers
3. **Existing user base** - Nostr users can access Solid pods without new accounts
4. **Key reuse** - Same keys used for Nostr, Bitcoin (Taproot), and now Solid

## Specification

### 1. Authentication Scheme

JSS SHALL accept the `Authorization: Nostr` HTTP header containing a base64-encoded NIP-98 event.

```
Authorization: Nostr <base64-encoded-event>
```

### 2. NIP-98 Event Structure

The event MUST conform to [NIP-98](https://nips.nostr.com/98):

```json
{
  "id": "<sha256-hash>",
  "pubkey": "<64-char-hex-public-key>",
  "created_at": <unix-timestamp>,
  "kind": 27235,
  "tags": [
    ["u", "<absolute-request-url>"],
    ["method", "<http-method>"],
    ["payload", "<sha256-of-body>"]
  ],
  "content": "",
  "sig": "<schnorr-signature>"
}
```

### 3. Validation Requirements

The server MUST verify:

| Check | Requirement |
|-------|-------------|
| `kind` | MUST be 27235 |
| `created_at` | MUST be within ±60 seconds of server time |
| `u` tag | MUST exactly match the absolute request URL |
| `method` tag | MUST match the HTTP method |
| `sig` | MUST be valid secp256k1 Schnorr signature per [BIP-340](https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki) |
| `payload` tag | If present, MUST match SHA-256 of request body |

### 4. Agent Identifier

Upon successful validation, the authenticated agent SHALL be identified as:

```
did:nostr:<64-char-lowercase-hex-pubkey>
```

Example:
```
did:nostr:63fe6318dc58583cfe16810f86dd09e18bfd76aabc24a0081ce2856f330504ed
```

### 5. ACL Authorization

The `did:nostr` URI MAY be used directly in WAC ACL files:

```turtle
@prefix acl: <http://www.w3.org/ns/auth/acl#>.

<#nostrAccess>
    a acl:Authorization;
    acl:agent <did:nostr:63fe6318dc58583cfe16810f86dd09e18bfd76aabc24a0081ce2856f330504ed>;
    acl:accessTo </shared/>;
    acl:mode acl:Read, acl:Write.
```

The `acl:AuthenticatedAgent` class SHALL include authenticated Nostr users.

### 6. WebID Linking (SSO)

To enable SSO, a WebID profile MAY link to a Nostr identity:

```json
{
  "@context": {
    "nostr": "https://w3id.org/nostr/vocab#",
    "owl": "http://www.w3.org/2002/07/owl#"
  },
  "@id": "https://example.com/alice/#me",
  "@type": "foaf:Person",
  "owl:sameAs": "did:nostr:63fe6318dc58583cfe16810f86dd09e18bfd76aabc24a0081ce2856f330504ed",
  "nostr:pubkey": "63fe6318dc58583cfe16810f86dd09e18bfd76aabc24a0081ce2856f330504ed"
}
```

### 7. SSO Flow

#### 7.1 Nostr → Existing WebID

1. User has existing JSS account with WebID
2. User links Nostr pubkey in account settings
3. Server stores `nostrPubkey` in account record
4. Server adds `owl:sameAs` to WebID profile
5. Future requests with NIP-98 resolve to the linked WebID

#### 7.2 Nostr-First Registration

1. User visits `/idp/nostr-login`
2. Browser extension (NIP-07) signs authentication event
3. Server verifies signature, extracts pubkey
4. If pubkey unknown, offer account creation:
   - Generate username from pubkey
   - Create pod with WebID containing `owl:sameAs did:nostr:...`
5. Issue session or return access token

### 8. Client Requirements

Clients SHOULD use [NIP-07](https://nips.nostr.com/7) browser extensions for key management:

```javascript
// Check for NIP-07 extension
if (window.nostr) {
  const event = {
    kind: 27235,
    created_at: Math.floor(Date.now() / 1000),
    tags: [
      ['u', 'https://example.com/resource'],
      ['method', 'GET']
    ],
    content: ''
  };
  const signed = await window.nostr.signEvent(event);
  const token = btoa(JSON.stringify(signed));

  fetch('https://example.com/resource', {
    headers: { 'Authorization': `Nostr ${token}` }
  });
}
```

## Security Considerations

1. **Replay Protection**: 60-second timestamp window prevents replay attacks
2. **URL Binding**: Signature includes exact URL, preventing cross-site use
3. **Key Isolation**: Private keys never leave NIP-07 extension
4. **HTTPS Required**: NIP-98 events MUST only be accepted over HTTPS (except localhost)

## Implementation

Reference implementation: [JavaScriptSolidServer](https://github.com/JavaScriptSolidServer/JavaScriptSolidServer)

Tracking issue: [#4](https://github.com/JavaScriptSolidServer/JavaScriptSolidServer/issues/4)

Dependencies:
- [nostr-tools](https://www.npmjs.com/package/nostr-tools) - NIP-98 validation

## Compatibility

| Spec | Compatibility |
|------|---------------|
| [Solid Protocol](https://solidproject.org/TR/protocol) | Compatible - extends authentication |
| [WAC](https://solidproject.org/TR/wac) | Compatible - `did:nostr` as agent URI |
| [Solid-OIDC](https://solidproject.org/TR/oidc) | Complementary - alternative auth method |
| [did:nostr](https://nostrcg.github.io/did-nostr/) | Implements |
| [NIP-98](https://nips.nostr.com/98) | Implements |
| [HTTP Schnorr Auth](https://nostrcg.github.io/http-schnorr-auth/) | Implements |

## References

- [NIP-98: HTTP Auth](https://nips.nostr.com/98)
- [NIP-07: window.nostr](https://nips.nostr.com/7)
- [did:nostr Method](https://nostrcg.github.io/did-nostr/)
- [HTTP Schnorr Auth W3C CG](https://nostrcg.github.io/http-schnorr-auth/)
- [BIP-340: Schnorr Signatures](https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki)
- [Solid WebID Profile](https://solid.github.io/webid-profile/)
- [nostr-tools npm](https://www.npmjs.com/package/nostr-tools)

## Changelog

- 2024-12-27: Initial draft
